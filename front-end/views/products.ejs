<%- include('partials/header', { user, token }) %>
<!DOCTYPE html>
<html>
<head>
  
  <!-- Top Navigation Bar -->
<!-- <div style="background-color: #333; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
  <div style="display: flex; gap: 20px;">
    <a href="/admin/products?token=<%= token %>" style="color: white; text-decoration: none;">ğŸ›’ Products</a>
    <a href="/admin/categories?token=<%= token %>" style="color: white; text-decoration: none;">ğŸ“¦ Categories</a>
    <a href="/admin/brand?token=<%= token %>" style="color: white; text-decoration: none;">ğŸ“¦ Brands</a>
    <a href="/admin/orders?token=<%= token %>" style="color: white; text-decoration: none;">ğŸ“‘ Orders</a>
    <a href="/admin/users?token=<%= token %>" style="color: white; text-decoration: none;">ğŸ‘¤ Users</a>
    <a href="/admin/memberships?token=<%= token %>" style="color: white; text-decoration: none;">ğŸ’³ Memberships</a>
  </div>
  <div>
    Logged in as <strong><%= user?.name || 'Admin' %></strong>
    <button onclick="logout()" style="margin-left: 10px; background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer;">
      Logout
    </button>
  </div>
</div> -->

  <title>Admin - Produkter</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <h1>Products</h1>
  <p>Manage products</p>

  <!-- Edit Modal -->
  <div id="editModal" style="display:none; position:fixed; top:10%; left:30%; background:white; padding:20px; border:1px solid #ccc;">
    <h3>Edit Product</h3>
    <form id="editForm">
      <input type="hidden" name="id" id="editId">
      <label>Name:</label><br>
      <input type="text" id="editName" name="name"><br>
      <label>Brand:</label><br>
      <input type="text" id="editBrand" name="brand"><br>
      <label>Category:</label><br>
      <input type="text" id="editCategory" name="category"><br>
      <label>Description:</label><br>
      <textarea id="editDescription" name="description"></textarea><br>
      <label>Quantity:</label><br>
      <input type="number" id="editQuantity" name="quantity"><br>
      <label>Price:</label><br>
      <input type="number" id="editPrice" name="unitprice" step="0.01"><br>
      <label>Image URL:</label><br>
      <input type="text" id="editImgUrl" name="imgurl"><br>
      <label>Is Deleted:</label><br>
      <label class="switch">
        <input type="checkbox" id="editIsDeleted" name="isdeleted">
        <span class="slider"></span>
      </label><br><br>
      <button type="button" onclick="submitEdit()">Save changes</button>
      <button type="button" onclick="closeModal()">Close</button>
    </form>
  </div>

  <!-- Searchbar -->
  <form method="POST" action="/admin/products/search?token=<%= token %>">
    <div style="display: flex; gap: 1rem;">
      <div>
        <label>Name</label><br>
        <input type="text" name="name" placeholder="Product name" value="<%= search.name || '' %>">
      </div>
      <div>
        <label>Category</label><br>
        <select name="category">
          <option value="">-- Select Category --</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat.name %>" <%= search.category === cat.name ? 'selected' : '' %>><%= cat.name %></option>
          <% }) %>
        </select>
      </div>
      <div>
        <label>Brand</label><br>
        <select name="brand">
          <option value="">-- Select Brand --</option>
          <% brands.forEach(b => { %>
            <option value="<%= b.name %>" <%= search.brand === b.name ? 'selected' : '' %>><%= b.name %></option>
          <% }) %>
        </select>
      </div>
      <div>
        <br>
        <button type="submit">Search</button>
        <a href="/admin/products?token=<%= token %>"><button type="button">Clear</button></a>
      </div>
    </div>
  </form>

  <!-- Product List -->
  <h2>Current products</h2>
  <table border="1" cellpadding="5">
    <thead>
      <tr>
        <th>Id</th>
        <th>Name</th>
        <th>Description</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Brand</th>
        <th>Category</th>
        <th>Image</th>
        <th>Date Added</th>
        <th>IsDeleted</th>
        <th>Options</th>
      </tr>
    </thead>
    <tbody>
      <% products.forEach(prod => { %>
        <tr>
          <td><%= prod.id %></td>
          <td><%= prod.name %></td>
          <td><%= prod.description %></td>
          <td><%= prod.quantity %></td>
          <td><%= prod.unitprice %></td>
          <td><%= prod.brand %></td>
          <td><%= prod.category %></td>
          <td><img src="<%= prod.imgurl %>" width="50" height="50" alt=""></td>
          <td><%= new Date(prod.createdAt).toLocaleDateString() %></td>
          <td>
            <label class="switch">
              <input type="checkbox" disabled <%= prod.isdeleted ? 'checked' : '' %>>
              <span class="slider"></span>
            </label>
          </td>
          <td>
            <button onclick="deleteProduct(<%= prod.id %>)" style="background-color: red; color: white;">ğŸ—‘</button>
            <button onclick="editProduct(<%= JSON.stringify(prod) %>)" style="background-color: orange; color: white;">âœï¸</button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

<script>
  function editProduct(prod) {
    document.getElementById('editModal').style.display = 'block';
    document.getElementById('editId').value = prod.id;
    document.getElementById('editName').value = prod.name;
    document.getElementById('editBrand').value = prod.brand;
    document.getElementById('editCategory').value = prod.category;
    document.getElementById('editDescription').value = prod.description;
    document.getElementById('editQuantity').value = prod.quantity;
    document.getElementById('editPrice').value = prod.unitprice;
    document.getElementById('editImgUrl').value = prod.imgurl;
    document.getElementById('editIsDeleted').checked = prod.isdeleted;
  }

  function closeModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  async function submitEdit() {
    const id = document.getElementById('editId').value;
    const token = new URLSearchParams(window.location.search).get('token');

    const updatedProduct = {
      name: document.getElementById('editName').value,
      brand: document.getElementById('editBrand').value,
      category: document.getElementById('editCategory').value,
      description: document.getElementById('editDescription').value,
      quantity: Number(document.getElementById('editQuantity').value),
      unitprice: Number(document.getElementById('editPrice').value),
      imgurl: document.getElementById('editImgUrl').value,
      isdeleted: document.getElementById('editIsDeleted').checked
    };

    try {
      const response = await fetch(`http://localhost:3000/products/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(updatedProduct)
      });

      if (response.ok) {
        alert('Product updated!');
        location.reload();
      } else {
        alert('Update failed.');
      }
    } catch (err) {
      console.error('Edit error:', err);
      alert('Something went wrong.');
    }
  }

  function deleteProduct(id) {
    if (confirm('Are you sure you want to delete this product?')) {
      const token = new URLSearchParams(window.location.search).get('token');

      const updatedProduct = { isdeleted: true };

      fetch(`http://localhost:3000/products/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(updatedProduct)
      })
      .then(response => {
        if (response.ok) {
          alert('Product deleted successfully.');
          location.reload();
        } else {
          alert('Failed to delete product.');
        }
      })
      .catch(error => {
        console.error('Error deleting product:', error);
        alert('An error occurred.');
      });
    }
  }

  function logout() {
    localStorage.removeItem('token');
    window.location.href = '/login';
  }
</script>
</body>
</html>
