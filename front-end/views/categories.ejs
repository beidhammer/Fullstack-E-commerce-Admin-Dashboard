<%- include('partials/header', { user, token }) %>
<h1>Category Management</h1>
<table border="1">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Options</th>
    </tr>
  </thead>
  <tbody>
    <% categories.forEach(c => { %>
      <tr>
        <td><%= c.id %></td>
        <td><%= c.name %></td>
        <td>
          <button onclick='openEditCategoryModal(<%- JSON.stringify(c) %>)'>‚úèÔ∏è</button>
          <button onclick='deleteCategory(<%= c.id %>)'>üóë</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<div id="editCategoryModal" style="display:none; position:fixed; top:10%; left:30%; background:white; padding:20px; border:1px solid #ccc;">
  <form id="editCategoryForm">
    <input type="hidden" name="id" id="editCategoryId">
    <label>Name:</label><br>
    <input type="text" id="editCategoryName"><br><br>
    <button type="submit">Save</button>
    <button type="button" onclick="closeEditCategoryModal()">Cancel</button>
  </form>
</div>

<script>
  function openEditCategoryModal(c) {
    document.getElementById('editCategoryModal').style.display = 'block';
    document.getElementById('editCategoryId').value = c.id;
    document.getElementById('editCategoryName').value = c.name;
  }

  function closeEditCategoryModal() {
    document.getElementById('editCategoryModal').style.display = 'none';
  }

  document.getElementById('editCategoryForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const id = document.getElementById('editCategoryId').value;
    const updatedCategory = {
      name: document.getElementById('editCategoryName').value
    };

    try {
      const response = await fetch(`http://localhost:3000/categories/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + new URLSearchParams(window.location.search).get('token')
        },
        body: JSON.stringify(updatedCategory)
      });

      if (response.ok) {
        alert('Category updated');
        location.reload();
      } else {
        alert('Failed to update category');
      }
    } catch (error) {
      console.error('Update error:', error);
      alert('Something went wrong.');
    }
  });

  async function deleteCategory(id) {
    if (!confirm('Are you sure you want to delete this category?')) return;
    try {
      const response = await fetch(`http://localhost:3000/categories/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + new URLSearchParams(window.location.search).get('token')
        }
      });

      if (response.ok) {
        alert('Category deleted');
        location.reload();
      } else {
        alert('Failed to delete category');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Something went wrong.');
    }
  }
</script>