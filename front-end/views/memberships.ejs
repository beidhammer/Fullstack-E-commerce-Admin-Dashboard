<%- include('partials/header', { user, token }) %>
<h1>Membership Management</h1>
<table border="1">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Options</th>
    </tr>
  </thead>
  <tbody>
    <% memberships.forEach(m => { %>
      <tr>
        <td><%= m.id %></td>
        <td><%= m.name %></td>
        <td>
          <button onclick='openEditMembershipModal(<%- JSON.stringify(m) %>)'>‚úèÔ∏è</button>
          <button onclick='deleteMembership(<%= m.id %>)'>üóë</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<div id="editMembershipModal" style="display:none; position:fixed; top:10%; left:30%; background:white; padding:20px; border:1px solid #ccc;">
  <form id="editMembershipForm">
    <input type="hidden" name="id" id="editMembershipId">
    <label>Name:</label><br>
    <input type="text" id="editMembershipName"><br><br>
    <button type="submit">Save</button>
    <button type="button" onclick="closeEditMembershipModal()">Cancel</button>
  </form>
</div>

<script>
  function openEditMembershipModal(m) {
    document.getElementById('editMembershipModal').style.display = 'block';
    document.getElementById('editMembershipId').value = m.id;
    document.getElementById('editMembershipName').value = m.name;
  }

  function closeEditMembershipModal() {
    document.getElementById('editMembershipModal').style.display = 'none';
  }

  document.getElementById('editMembershipForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const id = document.getElementById('editMembershipId').value;
    const updatedMembership = {
      name: document.getElementById('editMembershipName').value
    };

    try {
      const response = await fetch(`http://localhost:3000/memberships/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + new URLSearchParams(window.location.search).get('token')
        },
        body: JSON.stringify(updatedMembership)
      });

      if (response.ok) {
        alert('Membership updated');
        location.reload();
      } else {
        alert('Failed to update membership');
      }
    } catch (error) {
      console.error('Update error:', error);
      alert('Something went wrong.');
    }
  });

  async function deleteMembership(id) {
    if (!confirm('Are you sure you want to delete this membership?')) return;
    try {
      const response = await fetch(`http://localhost:3000/memberships/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + new URLSearchParams(window.location.search).get('token')
        }
      });

      if (response.ok) {
        alert('Membership deleted');
        location.reload();
      } else {
        alert('Failed to delete membership');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Something went wrong.');
    }
  }
</script>
